\ TXTBLK - Information                                  971228es                                                                Convert ascii text files to forth screens.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ TXT2BLK - Load screen                                 971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     2 LOAD                          \ compile program                                                                               TURNKEY COPY TXT2BLK.COM        \ create turnkey application                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ TXT2BLK - INFILE OUTFILE HELP ERROR                   971228es                                                                \ Create file handles for input and output                      1 FILE INFILE      \ use buffer 1                               2 FILE OUTFILE     \ use buffer 2                                                                                               \ Show help and exit                                            : HELP  ( -- )                                                    CR ." Convert Text files to Forth BLOCKs" CR                    CR ." Use: txt2blk file[.TXT] file[.SCR]"  ABORT ;                                                                            \ Encountered file error, display filename and quit             : ERROR  ( -- )  FILENAME TYPE  ABORT ;                         -->                                                                                                                                                                                             \ TXT2BLK - CMD ARG                                     971228es\ Parse the CP/M command line for the n'th blank delimited      \ parameter.  Return the address and length and a true flag if  \ found, otherwise return false.                                : CMD  ( n -- adr u -1 | 0 )                                      0 0 ROT  128 COUNT  ROT 0 ?DO                                     2SWAP 2DROP                                                     BL SKIP  2DUP BL SCAN                                           ROT OVER -  ROT ROT                                           LOOP  2DROP                                                     DUP IF -1 ELSE AND THEN ;                                                                                                     \ Get argument - if none show help                              : ARG ( n -- adr u )                                              CMD 0= IF ( none ) HELP THEN ;                                -->                                                             \ TXT2BLK - OPEN-FILES COPY-ALL                         971228es\ Open source and destination files                             : OPEN-FILES  ( -- )                                              INFILE   1 ARG  S" TXT" +FILENAME  OPEN-FILE                      IF ." Can't open: "   ERROR THEN                              OUTFILE  2 ARG  S" SCR" +FILENAME  CREATE-FILE                    IF ." Can't create: " ERROR THEN ;                          \ Copy loop                                                     : COPY-ALL  ( -- )                                                BEGIN                                                             INFILE   PAD 64  2DUP BLANK  READ-LINE  SWAP DROP  0=         WHILE                                                             OUTFILE  PAD 64  OVER + SWAP  DO  I C@  BL MAX  I C!  LOOP               PAD 64  WRITE-FILE                                     ABORT" Error; probably out of disk space"                     REPEAT ;  -->                                                 \ TXT2BLK - CLOSE-FILES COPY                            971228es                                                                \ Close source and destination files                            : CLOSE-FILES  ( -- )                                             INFILE   CLOSE-FILE DROP                                        OUTFILE  FLUSH-FILE  CLOSE-FILE  OR                             IF ." Error closing " ERROR THEN ;                                                                                            \ Main                                                          : COPY ( -- )                                                     OPEN-FILES  COPY-ALL  CLOSE-FILES  BYE ;                                                                                                                                                                                                                                                                                                                                                      