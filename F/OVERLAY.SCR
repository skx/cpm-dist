\ Overlay - Information                                 971228es                                                                These screens shows how to implement an overlay system for      DX-Forth.  It allows the creation of applications larger than   would otherwise be possible.                                                                                                    Saving and loading of overlays uses the read/write record file  commands - this makes for very fast operation and does not      require any file buffer space.                                                                                                  NOTE: when running or debugging programs using overlays, do not attempt to execute a word in an overlay if that overlay is not  currently loaded - it will cause the system to crash.                                                                                                                                                                                                           \ Overlay - Load screen                                 971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     CR .( loading Overlay )   2 LOAD                                                                                                CR .( .. making demo )    4 LOAD                                   .( .. testing )          TEST                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                \ Overlay - OBASE OSIZE OFILE LOAD-OVERLAY              971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     VARIABLE OBASE      \ base address of the overlay segment       VARIABLE OSIZE      \ size of largest overlay segment (records)                                                                 \ Create file handle for overlays                               0 FILE OFILE        \ no file-buffer required                                                                                   \ Load overlay segment                                          : LOAD-OVERLAY  ( c-addr u -- ior )                               OFILE  OPEN-FILE >R  OBASE @  OSIZE @                           READ-RECORD SWAP DROP  CLOSE-FILE  R> OR OR ;                 -->                                                                                                                             \ Overlay - OVERLAY                                     971228esSYSTEM                                                          \ Save overlay to disk and discard segment memory               : OVERLAY  ( <filename> -- )                                      BL WORD COUNT                                                   OFILE  CREATE-FILE ABORT" can't create overlay"                 OBASE @  HERE OVER -  DUP >R              \ overlay size        128 /MOD SWAP 0= NOT -                    \ records to save     DUP  OSIZE @  MAX  OSIZE !                \ update max size     WRITE-RECORD ABORT" can't write overlay"                        CLOSE-FILE ABORT" can't close overlay"                          R> NEGATE ALLOT ;                         \ discard memory    APPLICATION                                                                                                                                                                                                                                                     \ Overlay - Demo                                        971228esAPPLICATION             \ MUST be located in application space  HERE OBASE !            \ overlay start address                    0 OSIZE !            \ initial size                                                                                          : WORD1  ( -- )  CR ." This is WORD1 from SAMPLE1.OVL" ;        OVERLAY SAMPLE1.OVL                                                                                                             : WORD2  ( -- )  CR ." This is WORD2 from SAMPLE2.OVL" ;        OVERLAY SAMPLE2.OVL                                                                                                             : WORD3  ( -- )  CR ." This is WORD3 from SAMPLE3.OVL" ;        OVERLAY SAMPLE3.OVL                                                                                                             OSIZE @ 128 * ALLOT     \ reserve memory for overlays           -->                                                             \ Overlay - Demo                                        971228es\ Display file error msg and abort                              : FILE-ERROR  ( c-addr u -- )                                     CR TYPE FILENAME TYPE ABORT ;                                                                                                 \ Load overlay, handle any errors                               : OLOAD  ( c-addr u -- )                                          LOAD-OVERLAY IF S" Error loading overlay: " FILE-ERROR THEN ;                                                                 \ Create loader for each overlay                                : OVERLAY1  ( -- )  S" SAMPLE1.OVL" OLOAD ;                     : OVERLAY2  ( -- )  S" SAMPLE2.OVL" OLOAD ;                     : OVERLAY3  ( -- )  S" SAMPLE3.OVL" OLOAD ;                                                                                     \ Test the overlays                                             : TEST  ( -- )  OVERLAY1 WORD1  OVERLAY2 WORD2  OVERLAY3 WORD3 ;