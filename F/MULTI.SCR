\ Multitasker - Information                             971228es                                                                A co-operative multitasker.                                                                                                     TASK:  ( psize rsize -- )   define task                         TASKER  ( -- )              initialise and run multitasker      PAUSE  ( -- )               switch to next active task          ACTIVATE  ( t-addr -- )     initialise and wake another task    SLEEP  ( t-addr -- )        suspend another task                WAKE  ( t-addr -- )         resume another task                 STOP  ( -- )                stop current task, switch to next   SINGLE  ( -- )              suspend multitasking                MULTI  ( -- )               resume multitasking                 SIGNAL  ( s-addr -- )       signal resource is available        WAIT  ( s-addr -- )         wait until resource is available                                                                    \ Multitasker - Load screen                             971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     CR .( loading Multitasker )   2 LOAD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            \ Multitasker - TOS ENTRY LINK (LINK)                   971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     0 USER TOS                      \ save top of stack             2 USER ENTRY                    \ task active flag              4 USER LINK                     \ ptr to next task                                                                              -1 ENTRY !  ENTRY LINK !        \ init for single task                                                                          VARIABLE (LINK)                 \ LINK address of last task                                                                     LINK (LINK) !                   \ init link                     -->                                                                                                                                                                                             \ Multitasker - (PAUSE)                                 971228es\ Pause current task and switch to next active task             CODE (PAUSE)  ( -- )                                              B PUSH  RPP LHLD  H PUSH                  \ push IP RP          0 H LXI  SP DAD                           \ save SP to TOS      XCHG  UP LHLD  E M MOV  H INX  D M MOV                          H INX                                                         1 $: H INX  H INX  M E MOV  H INX  M D MOV  \ get active task     XCHG  M A MOV  A ORA  1 $ JZ                                    H DCX  H DCX  UP SHLD                     \ load UP             M E MOV  H INX  M D MOV                   \ restore SP          XCHG  SPHL                                                      H POP  RPP SHLD  B POP                    \ pop RP IP           NEXT JMP  END-CODE                                            -->                                                                                                                             \ Multitasker - >LOCAL SINGLE MULTI                     971228es\ Get address of local user                                     : >LOCAL  ( t-addr user -- addr )                                 TOS - + ;                                                                                                                     \ Suspend multitasking                                          CODE SINGLE  ( -- )                                               NEXT H LXI  ' PAUSE >BODY SHLD  NEXT JMP  END-CODE                                                                            \ Resume multitasking                                           CODE MULTI  ( -- )                                                ' (PAUSE) H LXI  ' PAUSE >BODY SHLD  NEXT JMP  END-CODE       -->                                                                                                                                                                                                                                                             \ Multitasker - TASKER SLEEP WAKE                       971228es\ Initialise and run multitasker                                : TASKER  ( -- )                                                  1 ENTRY !  ENTRY  (LINK) @  !  MULTI ;                                                                                        \ Suspend another task                                          : SLEEP  ( t-addr -- )                                            ENTRY >LOCAL  0 SWAP ! ;                                                                                                      \ Resume another task                                           : WAKE  ( t-addr -- )                                             ENTRY >LOCAL  -1 SWAP ! ;                                     -->                                                                                                                                                                                                                                                             \ Multitasker - STOP ACTIVATE                           971228es\ Stop current task and switch to next active task              : STOP  ( -- )                                                    TOS SLEEP PAUSE ;                                                                                                             \ Initialise and wake task                                      : ACTIVATE  ( t-addr -- )                                         DUP SLEEP                                                       DUP S0 >LOCAL @  2-  OVER 128 + @  OVER !                       2-  OVER R0 >LOCAL @  OVER !                                    OVER TOS >LOCAL !  WAKE ;                                     -->                                                                                                                                                                                                                                                                                                                             \ Multitasker - TASK:                                   971228esSYSTEM                                                          \ Define a task.  When executed, returns task address.          : TASK:  ( psize rsize -- )               \ param ret stack size  CREATE  ( -- taddr )                    \ base task user area   68 ROT + OVER +                         \ add space below PAD   TOS HERE  2DUP 128  DUP 2+ ALLOT  CMOVE \ set DP, copy user     DUP [ ASSEMBLER UP FORTH ] LITERAL !    \ switch to local UP    ENTRY (LINK) @  !  LINK (LINK) !        \ link to previous      2SWAP DUP HERE +  DUP R0 !  ROT - S0 !  \ set R0, S0            ROT [ ASSEMBLER UP FORTH ] LITERAL !    \ restore UP            ALLOT                                   \ allot space           ENTRY OVER LINK >LOCAL !  DUP SLEEP     \ link to next, sleep   128 + HERE SWAP !  !CSP SMUDGE ] ;      \ save IP, finish defnAPPLICATION                                                     -->                                                             \ Multitasker - SIGNAL WAIT                             971228es\ Semaphore words                                                                                                               \ Signal resource is available                                  : SIGNAL  ( s-addr -- )                                           -1 SWAP ! ;                                                                                                                   \ Wait until resource is available                              : WAIT  ( s-addr -- )                                             BEGIN PAUSE DUP @ UNTIL  0 SWAP ! ;                                                                                                                                                                                                                                                                                                                                                                                                                           