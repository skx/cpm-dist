\ Fast filecopy - Information                           971228es                                                                A filecopy utility to demonstrate the use of the disk functions READ-RECORD and WRITE-RECORD.  These are inherently faster than the buffered functions READ-CHAR and WRITE-CHAR.                                                                                The number of read and write operations is reduced to a minimum by buffering the records in memory.  This results in less disk  activity and a further improvement in speed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ Fast filecopy - Load screen                           971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     2 LOAD                          \ compile program                                                                               TURNKEY COPY COPYFAST.COM       \ create turnkey application                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ Fast filecopy - INFILE OUTFILE HELP ERROR             971228es                                                                \ Create file handles for input and output. File buffers are    \ not required for the unbuffered disk functions.               0 FILE INFILE      \ no buffer allocated                        0 FILE OUTFILE     \ no buffer allocated                                                                                        \ Show help and exit                                            : HELP  ( -- )                                                    1 ABORT" Usage: A>fastcopy file1 file2 <cr>" ;                                                                                \ Encountered file error, display filename and quit             : ERROR  ( -- )                                                   FILENAME TYPE  ABORT ;                                        -->                                                                                                                             \ Fast filecopy - CMD ARG                               971228es\ Parse the CP/M command line for the n'th blank delimited      \ parameter.  Return the address and length a true flag if      \ found, otherwise return false.                                : CMD  ( n -- adr u -1 | 0 )                                      0 0 ROT  128 COUNT  ROT 0 ?DO                                     2SWAP 2DROP                                                     BL SKIP  2DUP BL SCAN                                           ROT OVER -  ROT ROT                                           LOOP  2DROP                                                     DUP IF -1 ELSE AND THEN ;                                                                                                     \ Get argument - if none show help                              : ARG ( n -- adr u )                                              CMD 0= IF ( none ) HELP THEN ;                                -->                                                             \ Fast filecopy - BUFSIZE COPY-ALL                      971228es\ Determine the maximum number of records to hold in memory     : BUFSIZE ( -- records )                                          UNUSED  512 - ( allow space for forth stack etc.) 128 / ;                                                                     \ Open source and destination files                             : OPEN-FILES  ( -- )                                              INFILE  1 ARG  OPEN-FILE   IF ." Can't open: "   ERROR THEN     OUTFILE 2 ARG  CREATE-FILE IF ." Can't create: " ERROR THEN ; -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ Fast filecopy - COPY-ALL CLOSE-FILES                  971228es\ Copy loop                                                     : COPY-ALL ( -- )                                                 BEGIN                                                             INFILE   PAD BUFSIZE READ-RECORD                                ( recs flag ) 0=                                              WHILE                                                             OUTFILE  PAD SWAP WRITE-RECORD                                  ABORT" Error; probably out of disk space"                     REPEAT DROP ;                                                                                                                 \ Close source and destination files                            : CLOSE-FILES  ( -- )                                             INFILE   CLOSE-FILE DROP                                        OUTFILE  CLOSE-FILE IF ." Error closing " ERROR THEN ;        -->                                                             \ Fast filecopy - COPY                                  971228es                                                                \ Main                                                          : COPY ( -- )                                                     OPEN-FILES  COPY-ALL  CLOSE-FILES  BYE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      