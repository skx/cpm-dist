\ Install - Information                                 971228es                                                                This is the source to the DX-Forth installer program.                                                                           INSTALL customises the DX-Forth compiler or turnkey applicationsfor a variety of video terminals.  In addition, the CPU speed,  terminal delay times, arrow key codes and no-warmboot option maybe adjusted.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ Install - Load block                                  971228esFORTH DEFINITIONS  DECIMAL                                      APPLICATION                                                                                                                     : .VERSION  ( -- )  ." v1.0  28-Dec-97" ;                                                                                       CR .( loading DX-INSTALL )   2 LOAD  10 LOAD                                                                                    TURNKEY INSTALL INSTALL.COM     \ create turnkey application                                                                                                                                                                                                                                                                                                                                                                                                                                                                    \ ZINS - (Z1) (Z2)                                      971228esHEX                                                             \ Parse null-terminated string                                  CODE (Z1)  ( de=src hl=dst ; de=src' b=len )                      0FF B MVI  H PUSH                                              1 $:  B INR  H INX  D LDAX  D INX  A ORA                         3 $ JZ  CHAR \ CPI  2 $ JNZ  D LDAX  D INX                     2 $:  A M MOV  1 $ JMP                                          3 $:  H POP  B M MOV  RET  END-CODE                                                                                            \ Place counted string                                          CODE (Z2)  ( de=src hl=dst b=len )                                B M MOV  B INR                                                 1 $:  B DCR  RZ  D LDAX  D INX  H INX                            A M MOV  1 $ JMP  END-CODE                                    -->                                                             \ ZINS - (Z3)                                           971228es\ Parse cursor motion string                                    CODE (Z3)  ( de=src hl=dst ; de=scr' )                            0FF B MVI  A XRA  019C STA  019D STA  \ zero offsets            016B STA  016C STA  H PUSH            \ reset temp flags       1 $:  B INR  H INX                                              2 $:  D LDAX  D INX  A ORA  4 $ JZ     \ end                     CHAR % CPI  5 $ JZ                    \ command follows         CHAR \ CPI  3 $ JNZ  D LDAX  D INX    \ literal char follows   3 $:  A M MOV  1 $ JMP                                          4 $:  H POP  B M MOV                   \ insert count            016B LDA  A ORA  RZ                   \ make col first if req.  019C LHLD  L A MOV  H L MOV  A H MOV  019C SHLD                 019E LHLD  L A MOV  H L MOV  A H MOV  019E SHLD  RET          -->                                                                                                                             \ ZINS - (Z3)                                           971228es 5 $:  D LDAX  D INX            \ get next char                   CHAR a CPI  6 $ JC            \ make uppercase                  CHAR z 1+ CPI  6 $ JNC  20 SUI                                 6 $:                                                             CHAR + CPI  0B $ JZ           \ binary + offset                 CHAR . CPI  0D $ JZ           \ binary                          CHAR > CPI  0E $ JZ           \ binary greater + offset         CHAR R CPI  0F $ JZ           \ output col first                CHAR I CPI  10 $ JZ           \ home is 1,1                     CHAR N CPI  11 $ JZ           \ insert a null                   CHAR 2 CPI   8 $ JZ           \ decimal 2 digits                CHAR 3 CPI   7 $ JZ           \ decimal 3 digits                CHAR D CPI   3 $ JNZ          \ decimal else unknown command  -->                                                                                                                             \ ZINS - (Z3)                                           971228es  0168 LDA  64 CPI  8 $ JC          \ test if max columns < 100  7 $:  CHAR 0 M MVI  H INX  B INR   \ insert '000'               8 $:  CHAR 0 M MVI  H INX  B INR   \ insert '00'                      CHAR 0 M MVI                                               A XRA                             \ set decimal                9 $:  019B STA                                                   H PUSH                                                          019F H LXI  016C LDA              \ set row or col position     A ORA  0A $ JZ  H DCX             \ in cm template             0A $:  B M MOV  M INR                                            1 A MVI  016C STA                 \ set flag                    H POP  1 $ JMP                                                -->                                                                                                                                                                                             \ ZINS - (Z3)                                           971228es 0B $:  H PUSH  019D H LXI          \ binary + offset             016C LDA  A ORA  0C $ JZ  H DCX                                0C $:  D LDAX  D INX                                             M ADD  A M MOV  H POP                                          0D $:  A XRA  A M MOV              \ binary                      A INR  9 $ JMP                    \ set mode                   0E $:  D INX  D INX  0D $ JMP      \ skip parameters            0F $:  016B STA  2 $ JMP           \ set col first flag         10 $:  H PUSH  019C H LXI  M INR   \ home co-ords = 1,1          H INX  M INR  H POP  2 $ JMP                                   11 $:  A XRA  3 $ JMP              \ insert null                 END-CODE                                                      -->                                                                                                                                                                                             \ ZINS - ZINS                                           971228es\ Install terminal patch area with Z-System TermCap             CODE ZINS  ( -- )                                                 0109 LHLD  H A MOV  L ORA  NEXT JZ    \ exit if bad zenv        B PUSH                                \ save forth IP           02B D LXI  D DAD  M A MOV  0124 STA   \ cpu speed MHz             6 D LXI  D DAD  M A MOV  0168 STA   \ number of columns                  H INX  M A MOV  0169 STA   \ number of rows          04E D LXI  D DAD  XCHG  0153 H LXI    \ terminal name            0E B MVI  ' (Z2) CALL  XCHG  H INX  H INX                      014F B LXI    M A MOV  A ORA  2 $ JNZ   \ up arrow               5 A MVI  2 $:  B STAX                                          B INX  H INX  M A MOV  A ORA  3 $ JNZ   \ down arrow            18 A MVI  3 $:  B STAX                                        -->                                                                                                                             \ ZINS - ZINS                                           971228es  B INX  H INX  M A MOV  A ORA  4 $ JNZ   \ right arrow            4 A MVI  4 $: B STAX                                           B INX  H INX  M A MOV  A ORA  5 $ JNZ   \ left arrow            13 A MVI  5 $: B STAX                                           H INX  M A MOV  01BA STA              \ delay after cls         H INX  M A MOV  01A0 STA              \ delay after cm          H INX  M A MOV  01CE STA              \ delay after cleol       H INX  XCHG                                                     016B H LXI  ' (Z1) CALL               \ clear screen            D PUSH                                                          016C D LXI                                                      01A8 H LXI  0 M MVI                   \ zero home               B A MOV  6 CPI  6 $ JC                \ if cls too long         5 SUI  A C MOV  5 B MVI               \ split between ...     -->                                                             \ ZINS - ZINS                                           971228es  ' (Z2) CALL                           \ home sequence and       C B MOV  016C 5 + D LXI                                        6 $:  01A2 H LXI  ' (Z2) CALL          \ cls sequence            D POP                                                           018B H LXI  ' (Z3)  CALL              \ cursor motion           01BC H LXI  ' (Z1)  CALL              \ clear-to-EOL            01C2 H LXI  ' (Z1)  CALL              \ hilight                 01C8 H LXI  ' (Z1)  CALL              \ normal                  016B H LXI  ' (Z1)  CALL              \ video init              017B H LXI  ' (Z1)  CALL              \ video exit              01B4 H LXI  ' (Z1)  CALL              \ delete line             01AE H LXI  ' (Z1)  CALL              \ insert line             B POP                                 \ restore forth IP        NEXT JMP  END-CODE                                            DECIMAL                                                         \ Install - IN-FILE DTA-FILE #TERMS TLEN TERMINAL       971228es\ File handles for target file and terminal data file           0 FILE IN-FILE          \ no buffer required                    0 FILE DTA-FILE         \ no buffer required                                                                                    VARIABLE #TERMS         \ number of terminals in dta file       VARIABLE TLEN           \ length of each term definition        VARIABLE TERMINAL       \ terminal selected                                                                                     HEX 1D0 14F - DECIMAL CONSTANT TSIZE    \ size term install area                                                                \ Storage areas                                                 : TEMP      ( -- adr )  PAD 80 + ;      \ temporary storage     : IN-BASE   ( -- adr )  TEMP 256 + ;    \ target file (2 recs)  : DTA-BASE  ( -- adr )  IN-BASE 256 + ; \ dta file              -->                                                             \ Install - TDATA !STR !VAL                             971228es\ Get base address for n'th terminal data                       : TDATA  ( n -- adr )                                             TLEN @  *  DTA-BASE +  4 + ;                                                                                                  \ Place string from terminal data at offset to adr              : !STR  ( adr offs -- )                                           TERMINAL @  TDATA  + COUNT ROT PLACE ;                                                                                        \ Place value from terminal data at offset to adr               : !VAL  ( adr offs -- )                                           TERMINAL @  TDATA  + @ SWAP ! ;                               -->                                                                                                                                                                                                                                                             \ Install - TNAME TINIT TEXIT TCM TCLS THIL TNOR TINS   971228esHEX                                                             \ Store terminal data strings                                   : TNAME  ( -- ) 153  0 !STR ;       \ terminal name             : TINIT  ( -- ) 16B 16 !STR ;       \ term init                 : TEXIT  ( -- ) 17B 26 !STR ;       \ term exit                 : TCM    ( -- ) 18B 36 !STR ;       \ cursor motion template    : TCLS   ( -- ) 1A2 4D !STR ;       \ clear screen              : THOM   ( -- ) 1A8 53 !STR ;       \ home cursor               : THIL   ( -- ) 1C2 5B !STR ;       \ hilight video             : TNOR   ( -- ) 1C8 61 !STR ;       \ normal video              : TEOL   ( -- ) 1BC 69 !STR ;       \ clear to end-of-line      : TINS   ( -- ) 1AE 6F !STR ;       \ insert line               : TDEL   ( -- ) 1B4 75 !STR ;       \ delete line               DECIMAL                                                         -->                                                             \ Install - TBIN TPOS TOFFS TDCM TDCLS TDEOL TCR        971228esHEX                                                             \ Store terminal data values                                    : TBIN   ( -- ) 19B 46 !VAL ;       \ binary mode               ( note: TBIN must be executed before TOFFS )                    : TPOS   ( -- ) 19E 47 !VAL ;       \ col row pos               : TOFFS  ( -- ) 19C 49 !VAL ;       \ col row offset            : TDCM   ( -- ) 1A0 4B !VAL ;       \ cm delay                  : TDCLS  ( -- ) 1BA 59 !VAL ;       \ cls delay                 : TDEOL  ( -- ) 1CE 67 !VAL ;       \ eol delay                 : TCR    ( -- ) 168 7B !VAL ;       \ # cols rows               DECIMAL                                                         -->                                                                                                                                                                                                                                                             \ Install - SWAP-OUT SWAP-IN MOVE-DATA                  971228esHEX                                                             \ Save memory data before install                               : SWAP-OUT  ( -- )                                                124 C@  TEMP C!  14F  TEMP 1+  TSIZE MOVE ;                                                                                   \ Restore memory data after install                             : SWAP-IN  ( -- )                                                 TEMP C@  124 C!  TEMP 1+  14F  TSIZE MOVE ;                                                                                   \ Move memory data to in-file                                   : MOVE-DATA  ( -- )                                               14F IN-BASE 4F + TSIZE MOVE  124 C@  IN-BASE 24 + C! ;        DECIMAL                                                         -->                                                                                                                             \ Install - CMD                                         971228es\ Parse the CP/M command line for the n'th blank delimited      \ parameter.  Return the address and length and a true flag if  \ found, otherwise return false.                                : CMD  ( n -- adr u -1 | 0 )                                      0 0 ROT  128 COUNT  ROT 0 ?DO                                     2SWAP 2DROP                                                     BL SKIP  2DUP BL SCAN                                           ROT OVER -  ROT ROT                                           LOOP  2DROP                                                     DUP IF -1 ELSE AND THEN ;                                     -->                                                                                                                                                                                                                                                                                                                             \ Install - HELP ARG FILE-ERROR                         971228es\ Show help and exit                                            : HELP  ( -- )                                                    CR ." Installer for DX-Forth or compiled applications."         CR CR ." Use: INSTALL filename[.com] [termfile[.dta]]" ABORT ;                                                                \ Get argument - if none show help                              : ARG  ( n -- adr u )                                             CMD 0= IF ( none ) HELP THEN ;                                                                                                \ Encountered file error, display msg, filename then quit       : FILE-ERROR  ( adr u -- )                                        CR TYPE  FILENAME TYPE  ABORT ;                               -->                                                                                                                                                                                             \ Install - READ-TARGET                                 971228es\ Read first 2 records of target file into memory               : READ-TARGET  ( -- )                                             IN-FILE                               \ select filehandle       1 ARG                                 \ get first filename      S" COM" +FILENAME                     \ append filetype         OPEN-FILE                             \ open                    IF S" Error opening: " FILE-ERROR THEN                          IN-BASE                               \ buffer                  DUP 256 ERASE                         \ clear it                2 READ-RECORD DROP                    \ read 2 recs             2 =                                   \ check if got 2          IN-BASE 17 +  @  18051  =             \ check DX-Forth id.      AND 0=                                                          ABORT" Not DX-Forth or application" ;                         -->                                                             \ Install - READ-DTA                                    971228es\ Read DTA file into memory (files up to 16k may be read)       : READ-DTA  ( -- )                                                DTA-FILE                              \ select filehandle       2 CMD                                 \ if second filename      IF    S" DTA"  +FILENAME              \ append filetype         ELSE  S" INSTALL.DTA"  THEN           \ else use default        OPEN-FILE                             \ open file               IF  S" Error opening: " FILE-ERROR  THEN                        DTA-BASE                              \ buffer                  DUP [ 128 128 * ] LITERAL  ERASE      \ clear it                DUP 128 READ-RECORD  2DROP            \ read 128 recs           CLOSE-FILE DROP                       \ close file              DUP C@ #TERMS !                       \ get # terminals         2+  C@ TLEN ! ;                       \ get term data length  -->                                                             \ Install - WRITE-TARGET CLOSE-TARGET CLS               971228es\ Write data to file                                            : WRITE-TARGET  ( -- )                                            IN-FILE                               \ select filehandle       0 SEEK-RECORD                         \ reposition filepointer  IN-BASE 2 WRITE-RECORD                \ write 2 recs            IF S" Error writing: " FILE-ERROR THEN ;                      \ Close target file                                             : CLOSE-TARGET  ( -- )                                            IN-FILE                                                         CLOSE-FILE                                                      IF S" Error closing: " FILE-ERROR THEN ;                      \ Simple clear screen                                           : CLS  ( -- )                                                     40 0 DO CR LOOP ;                                             -->                                                             \ Install - SELECT INVALID ANYKEY                       971228es\ Select number in range n1 to n2.  Return n3 and true | false  : SELECT  ( n1 n2 -- n3 -1 | 0 )                                  CR ." Select: "  PAD 10 EXPECT CR         \ get input string    SPAN @  ?DUP  IF                          \                       PAD SWAP NUMBER?  IF                    \ convert to number       DROP  DUP  2SWAP  1+ WITHIN           \ check range             DUP 0=  IF  AND  THEN  EXIT  THEN                             THEN  2DROP  0 ;                                            \ Bad or empty input                                            : INVALID  ( -- )                                                 7 EMIT  CR ." Invalid or nothing entered" CR ;                \ Wait for a keypress                                           : ANYKEY  ( -- )                                                  CR ." Press any key to continue "  KEY DROP ;                 -->                                                             \ Install - (ROWS) .TERMINALS                           971228es\ Display terminal names including Z-System TCAP                : (ROWS)  ( -- n )                                                #TERMS @  1+  3 /MOD  SWAP  IF 1+ THEN  ;                     : .TERMINALS  ( -- )                                              CR  (ROWS) 0 ?DO                                                  3 0 ?DO                                                           I  (ROWS)  *  J +                                               DUP  #TERMS @  1+ <                                             IF  DUP 1+ 2 .R  SPACE  DUP #TERMS @ <                            IF  TDATA COUNT                                                 ELSE  DROP S" Z-SYSTEM TERMCAP"  THEN                           DUP >R  TYPE  23 R> - SPACES                                  ELSE  DROP  THEN  LOOP                                        CR LOOP ;                                                   -->                                                             \ Install - !TERM                                       971228es\ Install selected terminal                                     : !TERM  ( -- )                                                   SWAP-OUT  TERMINAL @  #TERMS @  =  IF                             ZENV  IF                                                          ZINS                                                          ELSE                                                              CR ." Z-SYSTEM not present" CR                                THEN                                                          ELSE                                                              TNAME TINIT TEXIT TCM TCLS THOM THIL TNOR TEOL TINS TDEL        TBIN TPOS TOFFS TDCM TDCLS TDEOL TCR                          THEN                                                            MOVE-DATA  SWAP-IN ;                                          -->                                                                                                                             \ Install - TERM-SELECT                                 971228es\ Edit terminal type                                            : TERM-SELECT  ( -- )                                             CLS  ." Terminal is currently "                                 IN-BASE 83 +  COUNT  -TRAILING TYPE                             ." .  Change? "  Y/N  IF                                          CR  .TERMINALS                          \ list terminals        1 #TERMS @ 1+ SELECT  IF                \ select                  1- TERMINAL !  !TERM                  \ store it              ELSE                                                              INVALID                                                       THEN                                                            ANYKEY  THEN ;                                              -->                                                                                                                                                                                             \ Install - CPU-SPEED                                   971228es\ Edit CPU speed                                                : CPU-SPEED  ( -- )                                               CLS  ." CPU speed is currently "                                IN-BASE 36 +  C@ .                                              ." MHz.  Change? "  Y/N  IF                                       CR ." Enter new value (1-31) "                                  1 31 SELECT  IF                                                   IN-BASE 36 +  C!                                              ELSE                                                              INVALID                                                       THEN                                                            ANYKEY  THEN ;                                              -->                                                                                                                                                                                             \ Install - DELAY                                       971228es\ Change the delay specified by the offset and string           : DELAY  ( offs adr u -- )                                        CR CR  TYPE ."  delay is currently "                            DUP  IN-BASE +  C@ .                                            ." mS.  Change? "  Y/N  IF                                        CR ." Enter new value (0-255) "                                 0 255 SELECT  IF                                                  SWAP  IN-BASE +  C!                                           ELSE                                                              DROP  INVALID                                                 THEN                                                            ANYKEY  THEN ;                                              -->                                                                                                                                                                                             \ Install - DELAY-TIMES                                 971228es\ Edit delay times                                              : DELAY-TIMES  ( -- )                                             CLS                                                             160  S" Cursor Motion"  DELAY                                   186  S" Clear Screen"  DELAY                                    206  S" Clear to End-of-Line"  DELAY ;                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ Install - ARROW                                       971228es\ Change the arrow key specified by the offset and string       : ARROW  ( offs adr u -- )                                        CR CR  TYPE ."  arrow key code is currently "                   DUP  IN-BASE +  C@                                              HEX  S>D <# # # #> TYPE  DECIMAL                                ."  hex.  Change? "  Y/N  IF                                      CR ." Enter new value in hexadecimal (00-FF) "                  HEX  0 255 SELECT  DECIMAL  IF                                    SWAP  IN-BASE +  C!                                           ELSE                                                              DROP  INVALID                                                 THEN                                                            ANYKEY  THEN ;                                              -->                                                                                                                             \ Install - WS-KEYS ARROW-KEYS                          971228es\ Store default WordStar arrow key codes                        : WS-KEYS  ( -- )                                                 [ HEX ] 18051304. [ DECIMAL ]                                   IN-BASE @  79 +  2! ;                                         \ Edit arrow key codes                                          : ARROW-KEYS  ( -- )                                              CLS  ." Use default WordStar arrow keys? "  Y/N  IF               WS-KEYS  CR ANYKEY                                            ELSE                                                              79  S" UP"     ARROW                                            80  S" DOWN"   ARROW                                            81  S" RIGHT"  ARROW                                            82  S" LEFT"   ARROW                                          THEN ;                                                        -->                                                             \ Install - NOBOOT                                      971228es\ Change the warmboot option                                    : NOBOOT  ( -- )                                                  CLS  ." NO WARMBOOT option is currently "                       IN-BASE 16 +  C@  IF ." ON"  ELSE ." OFF"  THEN                 ." .  Change? "  Y/N  IF                                          IN-BASE 16 +  DUP C@  0=  SWAP C!                               CR ANYKEY                                                       THEN ;                                                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             \ Install - SAVE-SETUP .MENU                            971228es\ Save setup to disk and exit                                   : SAVE-SETUP  ( -- )                                              CR ." Save current setup to disk? "  Y/N  IF                      WRITE-TARGET                                                    CLOSE-TARGET                                                    BYE  THEN ;                                                 \ Display main menu                                             : .MENU  ( -- )                                                   CR ."    1. Terminal selection"   CR ."    2. CPU speed"        CR ."    3. Time delays"          CR ."    4. Arrow key codes"  CR ."    5. No Warmboot option"                                 CR ."    6. Save changes and exit" ;                          -->                                                                                                                                                                                             \ Install - MENU                                        971228es\ Main menu loop. Exit if invalid option or nothing is entered. : MENU  ( -- )                                                    BEGIN                                                             .MENU  CR  1 6 SELECT  IF                                         CASE  1 OF  TERM-SELECT  ENDOF                                        2 OF  CPU-SPEED    ENDOF                                        3 OF  DELAY-TIMES  ENDOF                                        4 OF  ARROW-KEYS   ENDOF                                        5 OF  NOBOOT       ENDOF                                        6 OF  SAVE-SETUP   ENDOF                                  ENDCASE                                                       ELSE  BYE  THEN                                                 CLS  AGAIN ;                                                -->                                                                                                                             \ Install - INSTALL                                     971228es\ Main                                                          : INSTALL  ( -- )                                                 CLS  ." DX-INSTALL " .VERSION CR                                READ-TARGET                                                     READ-DTA                                                        MENU                                                            BYE ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         